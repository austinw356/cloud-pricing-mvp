<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Magalu Cloud Pricing Calculator</title>
  <style>
    /* Basic styling */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
    }
    .header {
      background-color: #007aff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-title {
      color: #fff;
      font-weight: 600;
      font-size: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto 60px auto;
      padding: 0 20px;
    }
    .page-intro {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .page-intro h1 {
      margin-top: 0;
    }
    .resource-section {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 40px;
    }
    .resource-section h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
      font-size: 1.25rem;
    }
    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
    }
    select, input[type="number"] {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .price-display {
      margin: 10px 0;
      font-weight: bold;
      font-size: 1em;
      color: #007bff;
    }
    button {
      cursor: pointer;
      background: #007aff;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 8px 16px;
      margin-top: 8px;
    }
    button:hover {
      background: #005bb5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background-color: #f9f9f9;
    }
    tfoot td {
      font-weight: bold;
      background: #f0f0f0;
    }
    .summary-section {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 30px;
    }
    .summary-section p {
      margin: 8px 0;
      font-weight: bold;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 class="header-title">Magalu Cloud Pricing Calculator</h1>
  </div>

  <div class="container">
    <div class="page-intro">
      <h1>Calculate Your Monthly Costs</h1>
      <p>All data loaded from <code>skus.json</code>. Windows BV excludes 1 vCPU.</p>
    </div>

    <!-- *******************************
         VIRTUAL MACHINES
    ******************************* -->
    <div class="resource-section">
      <h2>Virtual Machines</h2>

      <div class="field">
        <label for="vmPerfClass">Performance Class:</label>
        <select id="vmPerfClass">
          <option value="BV">Balanced Value (BV)</option>
          <option value="DP">Dedicated Performance (DP)</option>
        </select>
      </div>

      <div class="field">
        <label for="vmOsType">OS Type:</label>
        <select id="vmOsType">
          <option value="Linux">Linux</option>
          <option value="Windows">Windows</option>
        </select>
      </div>

      <div class="field">
        <label for="vmMemoryRatio">Memory Ratio (RAM / vCPU):</label>
        <select id="vmMemoryRatio"></select>
      </div>

      <div class="field">
        <label for="vmVcpus">VM Size (# of vCPUs):</label>
        <select id="vmVcpus"></select>
      </div>

      <div class="field">
        <label for="vmLocalDisk">Local Disk (GiB) [included in base price]:</label>
        <select id="vmLocalDisk"></select>
        <span style="font-size:0.85em;color:#555;">
          (Windows BV => [2,4,8] vCPUs, no 1)
        </span>
      </div>

      <div class="field">
        <label for="vmGpu">Optional GPU:</label>
        <select id="vmGpu">
          <option value="0">No GPU</option>
          <option value="1">1x Nvidia L40 (+R$5110)</option>
          <option value="2">2x Nvidia L40 (+R$10220)</option>
        </select>
        <span id="vmGpuNote" style="color: #d00; margin-left: 10px;"></span>
      </div>

      <div class="field">
        <label for="vmQuantity">Quantity of Instances:</label>
        <input type="number" id="vmQuantity" value="1" min="1" />
      </div>

      <div id="vmPricePerInstance" class="price-display">Price per Instance: R$0.00</div>
      <button id="addVmBtn">Add VM Configuration</button>

      <table id="vmTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Perf Class</th>
            <th>vCPUs</th>
            <th>RAM (GB)</th>
            <th>OS</th>
            <th>Local Disk</th>
            <th>GPU(s)</th>
            <th>Qty</th>
            <th>Subtotal (R$)</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="2">Totals</td>
            <td id="vmSumVcpus">0</td>
            <td id="vmSumRam">0</td>
            <td></td>
            <td id="vmSumDisk">0</td>
            <td id="vmSumGpu">0</td>
            <td id="vmSumQty">0</td>
            <td id="vmSumSubtotal">R$0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- *******************************
         OBJECT STORAGE
    ******************************* -->
    <!-- (unchanged logic) -->

    <!-- *******************************
         BLOCK STORAGE
    ******************************* -->
    <!-- (unchanged logic) -->

    <!-- *******************************
         SUMMARY
    ******************************* -->
    <div class="summary-section">
      <p>Virtual Machines: <span id="summaryVmSubtotal">R$0.00</span></p>
      <p>Object Storage: <span id="summaryObjectSubtotal">R$0.00</span></p>
      <p>Block Storage: <span id="summaryBlockSubtotal">R$0.00</span></p>
      <hr/>
      <p>Overall Monthly Total: <span id="overallTotal">R$0.00</span></p>
    </div>
  </div>

  <script>
    // Global data
    let vmSkus = [];
    let objectSkus = [];
    let blockSkus = [];

    // 1) Load skus.json
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      const data = await loadAllSkus('skus.json');
      if (!data) {
        alert('Could not load skus.json');
        return;
      }
      vmSkus = data.virtualMachines || [];
      objectSkus = data.objectStorage || [];
      blockSkus = data.blockStorage || [];

      setupVmForm();
      // ... plus calls for object & block storage if needed
    }

    async function loadAllSkus(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) return null;
        return await response.json();
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    // ===================
    // 2) Virtual Machines
    // ===================
    let vmList = [];

    // For memory ratio
    const memBV = [1, 2, 4];
    const memDP = [2, 4, 8];

    function setupVmForm() {
      // setup event listeners
      vmPerfClassEl.addEventListener('change', updateVmForm);
      vmOsTypeEl.addEventListener('change', updateVmForm);
      vmMemoryRatioEl.addEventListener('change', updateVmPricePerInstance);
      vmVcpusEl.addEventListener('change', updateVmPricePerInstance);
      vmLocalDiskEl.addEventListener('change', updateVmPricePerInstance);
      vmGpuEl.addEventListener('change', updateVmPricePerInstance);

      addVmBtn.addEventListener('click', addVmItem);

      // initial
      updateVmForm();
    }

    function updateVmForm() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal = vmOsTypeEl.value;

      // 2A) Memory ratio
      let memArr = (perfClassVal === 'BV') ? memBV : memDP;
      vmMemoryRatioEl.innerHTML = '';
      memArr.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        vmMemoryRatioEl.appendChild(opt);
      });

      // 2B) vCPUs
      let vcpusArr = [];
      if (perfClassVal === 'BV' && osVal === 'Linux') {
        vcpusArr = [1, 2, 4, 8];
      } else if (perfClassVal === 'BV' && osVal === 'Windows') {
        // <-- exclude 1
        vcpusArr = [2, 4, 8];
      } else {
        // DP => [2,4,8,16,32,64]
        vcpusArr = [2, 4, 8, 16, 32, 64];
      }
      vmVcpusEl.innerHTML = '';
      vcpusArr.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vmVcpusEl.appendChild(opt);
      });

      // 2C) local disk (filter from vmSkus)
      const diskOpts = getLocalDiskOptions(perfClassVal, osVal);
      vmLocalDiskEl.innerHTML = '';
      diskOpts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        vmLocalDiskEl.appendChild(opt);
      });

      // 2D) GPU logic
      let disableGPU = false;
      let note = '';
      if (perfClassVal === 'DP') {
        disableGPU = true;
        note = 'No GPU on DP';
      } else if (osVal === 'Windows') {
        disableGPU = true;
        note = 'No GPU on Windows';
      }
      vmGpuEl.disabled = disableGPU;
      if (disableGPU) {
        vmGpuEl.value = '0';
        vmGpuNoteEl.textContent = note;
      } else {
        vmGpuNoteEl.textContent = '';
      }

      updateVmPricePerInstance();
    }

    function getLocalDiskOptions(perfClass, os) {
      // filter from vmSkus
      const subset = vmSkus.filter(sku =>
        sku.perfClass === perfClass && sku.os === os
      );
      const uniqueDisks = [...new Set(subset.map(i => i.localDisk))].sort((a,b)=>a-b);
      return uniqueDisks;
    }

    function getVmBasePrice(perfClass, os, vcpus, memoryRatio, localDisk) {
      const match = vmSkus.find(item =>
        item.perfClass === perfClass &&
        item.os === os &&
        item.vcpus === parseInt(vcpus, 10) &&
        item.memoryRatio === parseInt(memoryRatio, 10) &&
        item.localDisk === parseInt(localDisk, 10)
      );
      return match ? match.monthlyBasePrice : 0;
    }

    function updateVmPricePerInstance() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal = vmOsTypeEl.value;
      const memRatioVal = parseInt(vmMemoryRatioEl.value, 10);
      const vcpusVal = parseInt(vmVcpusEl.value, 10);
      const diskVal = parseInt(vmLocalDiskEl.value, 10);

      let base = getVmBasePrice(perfClassVal, osVal, vcpusVal, memRatioVal, diskVal);

      // GPU
      let gpuVal = parseInt(vmGpuEl.value, 10) || 0;
      let gpuCost = gpuVal * 5110;

      let single = base + gpuCost;
      vmPricePerInstanceEl.textContent = 'Price per Instance: R$' + single.toFixed(2);
    }

    function addVmItem() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal = vmOsTypeEl.value;
      const memRatioVal = parseInt(vmMemoryRatioEl.value, 10);
      const vcpusVal = parseInt(vmVcpusEl.value, 10);
      const diskVal = parseInt(vmLocalDiskEl.value, 10);
      const gpuVal = parseInt(vmGpuEl.value, 10) || 0;
      const qtyVal = parseInt(vmQuantityEl.value, 10);

      let base = getVmBasePrice(perfClassVal, osVal, vcpusVal, memRatioVal, diskVal);
      let gpuCost = gpuVal * 5110;
      let instancePrice = base + gpuCost;
      let subtotal = instancePrice * qtyVal;

      let ramGB = memRatioVal * vcpusVal;

      let skuStr = [
        perfClassVal,
        `${vcpusVal}vCPU`,
        `${ramGB}GB`,
        osVal,
        `${diskVal}GiB`,
        `${gpuVal}GPU`
      ].join('-');

      vmList.push({
        sku: skuStr,
        perfClass: perfClassVal,
        vcpus: vcpusVal,
        ramGB,
        os: osVal,
        disk: diskVal,
        gpu: gpuVal,
        quantity: qtyVal,
        subtotal
      });

      renderVmTable();
    }

    function renderVmTable() {
      const tbody = document.querySelector('#vmTable tbody');
      tbody.innerHTML = '';
      let sumVcpus = 0, sumRam = 0, sumDisk = 0, sumGpu = 0, sumQty = 0, sumCost = 0;

      vmList.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const skuTd = document.createElement('td'); skuTd.textContent = item.sku; tr.appendChild(skuTd);
        const perfTd = document.createElement('td'); perfTd.textContent = item.perfClass; tr.appendChild(perfTd);
        const vcpusTd = document.createElement('td'); vcpusTd.textContent = item.vcpus; tr.appendChild(vcpusTd);
        const ramTd = document.createElement('td'); ramTd.textContent = item.ramGB; tr.appendChild(ramTd);
        const osTd = document.createElement('td'); osTd.textContent = item.os; tr.appendChild(osTd);
        const diskTd = document.createElement('td'); diskTd.textContent = item.disk; tr.appendChild(diskTd);
        const gpuTd = document.createElement('td'); gpuTd.textContent = item.gpu; tr.appendChild(gpuTd);
        const qtyTd = document.createElement('td'); qtyTd.textContent = item.quantity; tr.appendChild(qtyTd);
        const subtotalTd = document.createElement('td');
        subtotalTd.textContent = 'R$' + item.subtotal.toFixed(2); 
        tr.appendChild(subtotalTd);

        const removeTd = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'X';
        removeBtn.addEventListener('click', () => {
          vmList.splice(idx, 1);
          renderVmTable();
        });
        removeTd.appendChild(removeBtn);
        tr.appendChild(removeTd);

        tbody.appendChild(tr);

        sumVcpus += item.vcpus * item.quantity;
        sumRam += item.ramGB * item.quantity;
        sumDisk += item.disk * item.quantity;
        sumGpu += item.gpu * item.quantity;
        sumQty += item.quantity;
        sumCost += item.subtotal;
      });

      vmSumVcpusEl.textContent = sumVcpus;
      vmSumRamEl.textContent = sumRam;
      vmSumDiskEl.textContent = sumDisk;
      vmSumGpuEl.textContent = sumGpu;
      vmSumQtyEl.textContent = sumQty;
      vmSumSubtotalEl.textContent = 'R$' + sumCost.toFixed(2);

      updateSummary();
    }

    /* (unchanged code for object storage, block storage, overall summary) */
    // ...
    const summaryVmSubtotalEl     = document.getElementById('summaryVmSubtotal');
    const summaryObjectSubtotalEl = document.getElementById('summaryObjectSubtotal');
    const summaryBlockSubtotalEl  = document.getElementById('summaryBlockSubtotal');
    const overallTotalEl          = document.getElementById('overallTotal');

    function updateSummary() {
      const vmCost = vmList.reduce((a, i) => a + i.subtotal, 0);
      // object, block sums omitted, you have them in your full code...
      let objectCost = 0;
      let blockCost = 0;
      // ...
      let overall = vmCost + objectCost + blockCost;

      summaryVmSubtotalEl.textContent = 'R$' + vmCost.toFixed(2);
      summaryObjectSubtotalEl.textContent = 'R$' + objectCost.toFixed(2);
      summaryBlockSubtotalEl.textContent = 'R$' + blockCost.toFixed(2);
      overallTotalEl.textContent = 'R$' + overall.toFixed(2);
    }
  </script>
</body>
</html>
