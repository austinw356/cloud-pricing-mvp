<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Magalu Cloud Pricing Calculator</title>
  <style>
    /* Basic styling */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
    }
    .header {
      background-color: #007aff; /* Magalu-style blue */
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-title {
      color: #fff;
      font-weight: 600;
      font-size: 20px;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto 60px auto;
      padding: 0 20px;
    }

    .page-intro {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .page-intro h1 {
      margin-top: 0;
    }
    .page-intro p {
      margin-bottom: 0;
      color: #555;
    }

    .resource-section {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 40px;
    }
    .resource-section h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
      font-size: 1.25rem;
    }

    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
    }
    select, input[type="number"], input[type="text"] {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .price-display {
      margin: 10px 0;
      font-weight: bold;
      font-size: 1em;
      color: #007bff;
    }

    button {
      cursor: pointer;
      background: #007aff;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 8px 16px;
      margin-top: 8px;
    }
    button:hover {
      background: #005bb5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background-color: #f9f9f9;
    }
    tfoot td {
      font-weight: bold;
      background: #f0f0f0;
    }

    .summary-section {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 30px;
    }
    .summary-section p {
      margin: 8px 0;
      font-weight: bold;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 class="header-title">Magalu Cloud Pricing Calculator</h1>
  </div>

  <div class="container">
    <div class="page-intro">
      <h1>Calculate Your Monthly Costs</h1>
      <p>
        All SKU data is loaded from <code>skus.json</code>.  
        Prices shown are monthly estimates (billed by the second). Taxes included.
      </p>
    </div>

    <!-- *******************************
         VIRTUAL MACHINES
    ******************************* -->
    <div class="resource-section">
      <h2>Virtual Machines</h2>

      <div class="field">
        <label for="vmPerfClass">Performance Class:</label>
        <select id="vmPerfClass">
          <option value="BV">Balanced Value (BV)</option>
          <option value="DP">Dedicated Performance (DP)</option>
        </select>
      </div>

      <div class="field">
        <label for="vmOsType">OS Type:</label>
        <select id="vmOsType">
          <option value="Linux">Linux</option>
          <option value="Windows">Windows</option>
        </select>
      </div>

      <!-- We keep a simplified approach for memory ratio / vCPUs 
           but will do final cost lookups from the loaded vmSkus. -->
      <div class="field">
        <label for="vmMemoryRatio">Memory Ratio (RAM / vCPU):</label>
        <select id="vmMemoryRatio">
          <!-- We'll fill in from code or keep static for BV/DP. -->
        </select>
      </div>

      <div class="field">
        <label for="vmVcpus">VM Size (# of vCPUs):</label>
        <select id="vmVcpus">
          <!-- We'll fill in from code or keep static for BV/DP. -->
        </select>
      </div>

      <div class="field">
        <label for="vmLocalDisk">Local Disk (GiB) [included in base price]:</label>
        <select id="vmLocalDisk">
          <!-- We'll fill from JSON so user can only pick valid combos. -->
        </select>
      </div>

      <div class="field">
        <label for="vmGpu">Optional GPU:</label>
        <select id="vmGpu">
          <option value="0">No GPU</option>
          <option value="1">1x Nvidia L40 (+R$5110)</option>
          <option value="2">2x Nvidia L40 (+R$10220)</option>
        </select>
        <span id="vmGpuNote" style="color: #d00; margin-left: 10px;"></span>
      </div>

      <div class="field">
        <label for="vmQuantity">Quantity of Instances:</label>
        <input type="number" id="vmQuantity" value="1" min="1" />
      </div>

      <div id="vmPricePerInstance" class="price-display">Price per Instance: R$0.00</div>
      <button id="addVmBtn">Add VM Configuration</button>

      <!-- VM Table -->
      <table id="vmTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Perf Class</th>
            <th>vCPUs</th>
            <th>RAM (GB)</th>
            <th>OS</th>
            <th>Local Disk</th>
            <th>GPU(s)</th>
            <th>Qty</th>
            <th>Subtotal (R$)</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="2">Totals</td>
            <td id="vmSumVcpus">0</td>
            <td id="vmSumRam">0</td>
            <td></td>
            <td id="vmSumDisk">0</td>
            <td id="vmSumGpu">0</td>
            <td id="vmSumQty">0</td>
            <td id="vmSumSubtotal">R$0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- *******************************
         OBJECT STORAGE
    ******************************* -->
    <div class="resource-section">
      <h2>Object Storage</h2>

      <div class="field">
        <label for="osClass">Storage Class:</label>
        <select id="osClass">
          <!-- We'll fill from JSON or keep static. -->
        </select>
        <div id="osUnitPrice" class="price-display"></div>
      </div>

      <div class="field">
        <label for="osGiBs"># of GiBs (Storage):</label>
        <input type="number" id="osGiBs" value="500" min="1" />
      </div>

      <div class="field">
        <label for="osGiBsRetrieved">GiBs Retrieved per Month:</label>
        <input type="number" id="osGiBsRetrieved" value="100" min="0" />
      </div>

      <button id="addObjectStorageBtn">Add Object Storage</button>

      <table id="objectStorageTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Class</th>
            <th>GiBs Stored</th>
            <th>GiBs Retrieved</th>
            <th>Subtotal (R$)</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="2">Totals</td>
            <td id="osSumStored">0</td>
            <td id="osSumRetrieved">0</td>
            <td id="osSumSubtotal">R$0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- *******************************
         BLOCK STORAGE
    ******************************* -->
    <div class="resource-section">
      <h2>Block Storage Volumes</h2>

      <div class="field">
        <label>Storage Class:</label>
        <input type="text" value="NVMe Standard" disabled />
      </div>

      <div class="field">
        <label for="bsIops">IOPS:</label>
        <select id="bsIops">
          <!-- We'll fill from blockSkus array -->
        </select>
        <div id="bsUnitPrice" class="price-display"></div>
      </div>

      <div class="field">
        <label for="bsVolumeSize">Volume Size (GiB):</label>
        <input type="number" id="bsVolumeSize" value="250" min="10" max="1024" />
      </div>

      <div class="field">
        <label for="bsQuantity">Quantity of Volumes:</label>
        <input type="number" id="bsQuantity" value="1" min="1" />
      </div>

      <button id="addBlockStorageBtn">Add Block Volume</button>

      <table id="blockStorageTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>IOPS</th>
            <th>Size (GiB)</th>
            <th>Quantity</th>
            <th>Subtotal (R$)</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>Totals</td>
            <td id="bsSumIops">0</td>
            <td id="bsSumSize">0</td>
            <td id="bsSumQty">0</td>
            <td id="bsSumSubtotal">R$0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- *******************************
         SUMMARY
    ******************************* -->
    <div class="summary-section">
      <p>Virtual Machines: <span id="summaryVmSubtotal">R$0.00</span></p>
      <p>Object Storage: <span id="summaryObjectSubtotal">R$0.00</span></p>
      <p>Block Storage: <span id="summaryBlockSubtotal">R$0.00</span></p>
      <hr/>
      <p>Overall Monthly Total: <span id="overallTotal">R$0.00</span></p>
    </div>
  </div>

  <script>
    // Our global arrays, loaded at runtime from skus.json
    let vmSkus = [];
    let objectSkus = [];
    let blockSkus = [];

    // 1) On page load, fetch skus.json, then init the forms
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Load the JSON from GitHub Pages (or local)
      // if it's in the same folder, just 'skus.json'
      const data = await loadAllSkus('skus.json');
      if (!data) {
        alert('Could not load SKU data. Check console for errors.');
        return;
      }

      // Store in global arrays
      vmSkus = data.virtualMachines || [];
      objectSkus = data.objectStorage || [];
      blockSkus = data.blockStorage || [];

      // Now set up the VM form
      setupVmForm();

      // Set up object storage form
      setupObjectStorageForm();

      // Set up block storage form
      setupBlockStorageForm();

      // done
    }

    // Utility to fetch and parse JSON
    async function loadAllSkus(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          console.error('Network error loading', url);
          return null;
        }
        return await response.json();
      } catch (err) {
        console.error('Fetch error:', err);
        return null;
      }
    }

    /* ----------------------------------------
       2) VMs
    ---------------------------------------- */
    let vmList = [];

    // We'll keep arrays for memoryRatios and vCPUs for user-friendly dropdowns
    const memoryRatiosBV = [1, 2, 4];
    const memoryRatiosDP = [2, 4, 8];
    const vcpusBV = [1, 2, 4, 8];
    const vcpusDP = [2, 4, 8, 16, 32];

    const vmPerfClassEl   = document.getElementById('vmPerfClass');
    const vmOsTypeEl      = document.getElementById('vmOsType');
    const vmMemoryRatioEl = document.getElementById('vmMemoryRatio');
    const vmVcpusEl       = document.getElementById('vmVcpus');
    const vmLocalDiskEl   = document.getElementById('vmLocalDisk');
    const vmGpuEl         = document.getElementById('vmGpu');
    const vmGpuNoteEl     = document.getElementById('vmGpuNote');
    const vmQuantityEl    = document.getElementById('vmQuantity');
    const vmPricePerInstanceEl = document.getElementById('vmPricePerInstance');
    const addVmBtn        = document.getElementById('addVmBtn');

    const vmTableBody     = document.querySelector('#vmTable tbody');
    const vmSumVcpusEl    = document.getElementById('vmSumVcpus');
    const vmSumRamEl      = document.getElementById('vmSumRam');
    const vmSumDiskEl     = document.getElementById('vmSumDisk');
    const vmSumGpuEl      = document.getElementById('vmSumGpu');
    const vmSumQtyEl      = document.getElementById('vmSumQty');
    const vmSumSubtotalEl = document.getElementById('vmSumSubtotal');

    function setupVmForm() {
      // Set defaults
      updateVmForm();
      // Add listeners
      vmPerfClassEl.addEventListener('change', updateVmForm);
      vmOsTypeEl.addEventListener('change', updateVmForm);

      vmMemoryRatioEl.addEventListener('change', updateVmPricePerInstance);
      vmVcpusEl.addEventListener('change', updateVmPricePerInstance);
      vmLocalDiskEl.addEventListener('change', updateVmPricePerInstance);
      vmGpuEl.addEventListener('change', updateVmPricePerInstance);

      addVmBtn.addEventListener('click', addVmItem);
    }

    // For VMs, we do a "getLocalDiskOptions" by scanning vmSkus
    function getLocalDiskOptions(perfClass, os) {
      // Filter from vmSkus
      const subset = vmSkus.filter(sku =>
        sku.perfClass === perfClass && sku.os === os
      );
      // Return unique disk sizes from that subset
      const uniqueDisks = [...new Set(subset.map(i => i.localDisk))].sort((a,b)=>a-b);
      return uniqueDisks;
    }

    function getVmBasePrice(perfClass, os, vcpus, memoryRatio, localDisk) {
      const match = vmSkus.find(item =>
        item.perfClass === perfClass &&
        item.os === os &&
        item.vcpus === parseInt(vcpus, 10) &&
        item.memoryRatio === parseInt(memoryRatio, 10) &&
        item.localDisk === parseInt(localDisk, 10)
      );
      return match ? match.monthlyBasePrice : 0;
    }

    function updateVmForm() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal = vmOsTypeEl.value;

      // Update memory ratio
      const ratios = (perfClassVal === 'BV') ? memoryRatiosBV : memoryRatiosDP;
      vmMemoryRatioEl.innerHTML = '';
      ratios.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        vmMemoryRatioEl.appendChild(opt);
      });

      // Update vCPUs
      const vcpusArr = (perfClassVal === 'BV') ? vcpusBV : vcpusDP;
      vmVcpusEl.innerHTML = '';
      vcpusArr.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vmVcpusEl.appendChild(opt);
      });

      // Update local disk from the loaded vmSkus
      const diskOpts = getLocalDiskOptions(perfClassVal, osVal);
      vmLocalDiskEl.innerHTML = '';
      diskOpts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        vmLocalDiskEl.appendChild(opt);
      });

      // GPU logic
      let disableGPU = false;
      let note = '';
      if (perfClassVal === 'DP') {
        disableGPU = true;
        note = 'No GPU on DP';
      } else if (osVal === 'Windows') {
        disableGPU = true;
        note = 'No GPU on Windows';
      }
      vmGpuEl.disabled = disableGPU;
      if (disableGPU) {
        vmGpuEl.value = '0';
        vmGpuNoteEl.textContent = note;
      } else {
        vmGpuNoteEl.textContent = '';
      }

      updateVmPricePerInstance();
    }

    function updateVmPricePerInstance() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal        = vmOsTypeEl.value;
      const memRatioVal  = vmMemoryRatioEl.value;
      const vcpusVal     = vmVcpusEl.value;
      const diskVal      = vmLocalDiskEl.value;

      // find base price in vmSkus
      let basePrice = getVmBasePrice(perfClassVal, osVal, vcpusVal, memRatioVal, diskVal);

      // GPU upcharge
      let gpuVal = parseInt(vmGpuEl.value, 10) || 0;
      let gpuCost = gpuVal * 5110;

      let single = basePrice + gpuCost;
      vmPricePerInstanceEl.textContent = 'Price per Instance: R$' + single.toFixed(2);
    }

    function addVmItem() {
      const perfClassVal = vmPerfClassEl.value;
      const osVal        = vmOsTypeEl.value;
      const memRatioVal  = parseInt(vmMemoryRatioEl.value, 10);
      const vcpusVal     = parseInt(vmVcpusEl.value, 10);
      const diskVal      = parseInt(vmLocalDiskEl.value, 10);
      const gpuVal       = parseInt(vmGpuEl.value, 10) || 0;
      const qtyVal       = parseInt(vmQuantityEl.value, 10);

      // find base price
      let basePrice = getVmBasePrice(perfClassVal, osVal, vcpusVal, memRatioVal, diskVal);

      // GPU cost
      let gpuCost = gpuVal * 5110;
      // total cost for 1 instance
      let instancePrice = basePrice + gpuCost;
      // multiply by quantity
      let subtotal = instancePrice * qtyVal;

      // Calculate RAM from ratio
      let ramGB = memRatioVal * vcpusVal;

      // Build SKU string (no "Qty" now)
      let skuString = [
        perfClassVal,
        `${vcpusVal}vCPU`,
        `${ramGB}GB`,
        osVal,
        `${diskVal}GiB`,
        `${gpuVal}GPU`
      ].join('-');

      vmList.push({
        sku: skuString,
        perfClass: perfClassVal,
        vcpus: vcpusVal,
        ramGB,
        os: osVal,
        disk: diskVal,
        gpu: gpuVal,
        quantity: qtyVal,
        subtotal
      });

      renderVmTable();
    }

    function renderVmTable() {
      vmTableBody.innerHTML = '';
      let sumVcpus = 0, sumRam = 0, sumDisk = 0, sumGpu = 0, sumQty = 0, sumVmCost = 0;

      vmList.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const skuTd = document.createElement('td');
        skuTd.textContent = item.sku;
        tr.appendChild(skuTd);

        const perfTd = document.createElement('td');
        perfTd.textContent = item.perfClass;
        tr.appendChild(perfTd);

        const vcpusTd = document.createElement('td');
        vcpusTd.textContent = item.vcpus;
        tr.appendChild(vcpusTd);

        const ramTd = document.createElement('td');
        ramTd.textContent = item.ramGB;
        tr.appendChild(ramTd);

        const osTd = document.createElement('td');
        osTd.textContent = item.os;
        tr.appendChild(osTd);

        const diskTd = document.createElement('td');
        diskTd.textContent = item.disk;
        tr.appendChild(diskTd);

        const gpuTd = document.createElement('td');
        gpuTd.textContent = item.gpu;
        tr.appendChild(gpuTd);

        const qtyTd = document.createElement('td');
        qtyTd.textContent = item.quantity;
        tr.appendChild(qtyTd);

        const subtotalTd = document.createElement('td');
        subtotalTd.textContent = 'R$' + item.subtotal.toFixed(2);
        tr.appendChild(subtotalTd);

        const removeTd = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'X';
        removeBtn.addEventListener('click', () => {
          vmList.splice(idx, 1);
          renderVmTable();
        });
        removeTd.appendChild(removeBtn);
        tr.appendChild(removeTd);

        vmTableBody.appendChild(tr);

        sumVcpus += item.vcpus * item.quantity;
        sumRam   += item.ramGB * item.quantity;
        sumDisk  += item.disk * item.quantity;
        sumGpu   += item.gpu * item.quantity;
        sumQty   += item.quantity;
        sumVmCost += item.subtotal;
      });

      vmSumVcpusEl.textContent    = sumVcpus;
      vmSumRamEl.textContent      = sumRam;
      vmSumDiskEl.textContent     = sumDisk;
      vmSumGpuEl.textContent      = sumGpu;
      vmSumQtyEl.textContent      = sumQty;
      vmSumSubtotalEl.textContent = 'R$' + sumVmCost.toFixed(2);

      updateSummary();
    }

    /* ----------------------------------------
       3) OBJECT STORAGE
    ---------------------------------------- */
    let objectStorageList = [];

    const osClassEl         = document.getElementById('osClass');
    const osGiBsEl          = document.getElementById('osGiBs');
    const osGiBsRetrievedEl = document.getElementById('osGiBsRetrieved');
    const addObjectStorageBtn = document.getElementById('addObjectStorageBtn');
    const objectStorageTableBody = document.querySelector('#objectStorageTable tbody');
    const osSumStoredEl     = document.getElementById('osSumStored');
    const osSumRetrievedEl  = document.getElementById('osSumRetrieved');
    const osSumSubtotalEl   = document.getElementById('osSumSubtotal');
    const osUnitPriceEl     = document.getElementById('osUnitPrice');

    function setupObjectStorageForm() {
      // Fill the "osClass" dropdown from objectSkus array
      osClassEl.innerHTML = '';
      objectSkus.forEach(osItem => {
        const opt = document.createElement('option');
        opt.value = osItem.class;
        opt.textContent = osItem.class;
        osClassEl.appendChild(opt);
      });

      handleOsClassChange();
      osClassEl.addEventListener('change', handleOsClassChange);
      addObjectStorageBtn.addEventListener('click', addObjectStorageItem);
    }

    function getObjectStorageSkuByClass(cls) {
      return objectSkus.find(item => item.class === cls) || null;
    }

    function handleOsClassChange() {
      const cls = osClassEl.value;
      const sku = getObjectStorageSkuByClass(cls);
      if (!sku) {
        osUnitPriceEl.textContent = 'Class not found in skus.json';
        return;
      }
      // Show user the price
      if (sku.retrievalCost === 0) {
        osUnitPriceEl.textContent = `R$${sku.pricePerGB.toFixed(2)} per GiB stored (no retrieval fee)`;
        osGiBsRetrievedEl.value = '0';
        osGiBsRetrievedEl.disabled = true;
      } else {
        osUnitPriceEl.textContent = `R$${sku.pricePerGB.toFixed(2)} stored + R$${sku.retrievalCost.toFixed(2)} retrieval`;
        osGiBsRetrievedEl.disabled = false;
      }
    }

    function addObjectStorageItem() {
      const cls = osClassEl.value;
      const giBsVal = parseFloat(osGiBsEl.value) || 0;
      const retrievedVal = parseFloat(osGiBsRetrievedEl.value) || 0;

      const sku = getObjectStorageSkuByClass(cls);
      if (!sku) {
        alert('No matching object storage SKU in JSON!');
        return;
      }

      let cost = (giBsVal * sku.pricePerGB) + (retrievedVal * sku.retrievalCost);

      const skuString = [
        cls,
        giBsVal + 'GiBs',
        (sku.retrievalCost > 0) ? (retrievedVal + 'Retrieved') : 'NoRetrieval'
      ].join('-');

      objectStorageList.push({
        sku: skuString,
        class: cls,
        giBs: giBsVal,
        giBsRetrieved: (sku.retrievalCost > 0) ? retrievedVal : 0,
        subtotal: cost
      });

      renderObjectStorageTable();
    }

    function renderObjectStorageTable() {
      objectStorageTableBody.innerHTML = '';
      let sumStored = 0, sumRetrieved = 0, sumCost = 0;

      objectStorageList.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const skuTd = document.createElement('td');
        skuTd.textContent = item.sku;
        tr.appendChild(skuTd);

        const classTd = document.createElement('td');
        classTd.textContent = item.class;
        tr.appendChild(classTd);

        const giBsTd = document.createElement('td');
        giBsTd.textContent = item.giBs;
        tr.appendChild(giBsTd);

        const retrievedTd = document.createElement('td');
        retrievedTd.textContent = item.giBsRetrieved;
        tr.appendChild(retrievedTd);

        const subtotalTd = document.createElement('td');
        subtotalTd.textContent = 'R$' + item.subtotal.toFixed(2);
        tr.appendChild(subtotalTd);

        const removeTd = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'X';
        removeBtn.addEventListener('click', () => {
          objectStorageList.splice(idx, 1);
          renderObjectStorageTable();
        });
        removeTd.appendChild(removeBtn);
        tr.appendChild(removeTd);

        objectStorageTableBody.appendChild(tr);

        sumStored += item.giBs;
        sumRetrieved += item.giBsRetrieved;
        sumCost += item.subtotal;
      });

      osSumStoredEl.textContent = sumStored;
      osSumRetrievedEl.textContent = sumRetrieved;
      osSumSubtotalEl.textContent = 'R$' + sumCost.toFixed(2);

      updateSummary();
    }


    /* ----------------------------------------
       4) BLOCK STORAGE
    ---------------------------------------- */
    let blockStorageList = [];

    const bsIopsEl         = document.getElementById('bsIops');
    const bsVolumeSizeEl   = document.getElementById('bsVolumeSize');
    const bsQuantityEl     = document.getElementById('bsQuantity');
    const addBlockStorageBtn = document.getElementById('addBlockStorageBtn');
    const blockStorageTableBody = document.querySelector('#blockStorageTable tbody');
    const bsSumIopsEl      = document.getElementById('bsSumIops');
    const bsSumSizeEl      = document.getElementById('bsSumSize');
    const bsSumQtyEl       = document.getElementById('bsSumQty');
    const bsSumSubtotalEl  = document.getElementById('bsSumSubtotal');
    const bsUnitPriceEl    = document.getElementById('bsUnitPrice');

    function setupBlockStorageForm() {
      // fill the IOPS dropdown from blockSkus
      bsIopsEl.innerHTML = '';
      blockSkus.forEach(sku => {
        const opt = document.createElement('option');
        opt.value = sku.iops;
        opt.textContent = sku.iops;
        bsIopsEl.appendChild(opt);
      });
      bsIopsEl.addEventListener('change', showBlockStorageUnitPrice);
      showBlockStorageUnitPrice();

      addBlockStorageBtn.addEventListener('click', addBlockStorageItem);
    }

    function getBlockStorageSku(iops) {
      return blockSkus.find(item => item.iops === parseInt(iops, 10)) || null;
    }

    function showBlockStorageUnitPrice() {
      const iops = parseInt(bsIopsEl.value, 10);
      const sku = getBlockStorageSku(iops);
      if (!sku) {
        bsUnitPriceEl.textContent = 'No matching block SKU in JSON';
        return;
      }
      bsUnitPriceEl.textContent = `R$${sku.pricePerGB.toFixed(2)} per GiB`;
    }

    function addBlockStorageItem() {
      const iopsVal = parseInt(bsIopsEl.value, 10);
      const sizeVal = parseFloat(bsVolumeSizeEl.value) || 0;
      const qtyVal  = parseInt(bsQuantityEl.value, 10);

      const sku = getBlockStorageSku(iopsVal);
      if (!sku) {
        alert('No matching block storage SKU in JSON!');
        return;
      }

      const subtotal = sku.pricePerGB * sizeVal * qtyVal;
      const skuString = [
        'NVMeStd', 
        iopsVal + 'IOPS',
        sizeVal + 'GiB',
        'Qty' + qtyVal
      ].join('-');

      blockStorageList.push({
        sku: skuString,
        iops: iopsVal,
        size: sizeVal,
        quantity: qtyVal,
        subtotal
      });

      renderBlockStorageTable();
    }

    function renderBlockStorageTable() {
      blockStorageTableBody.innerHTML = '';
      let sumIops = 0, sumSize = 0, sumQty = 0, sumCost = 0;

      blockStorageList.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const skuTd = document.createElement('td');
        skuTd.textContent = item.sku;
        tr.appendChild(skuTd);

        const iopsTd = document.createElement('td');
        iopsTd.textContent = item.iops;
        tr.appendChild(iopsTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = item.size;
        tr.appendChild(sizeTd);

        const qtyTd = document.createElement('td');
        qtyTd.textContent = item.quantity;
        tr.appendChild(qtyTd);

        const subtotalTd = document.createElement('td');
        subtotalTd.textContent = 'R$' + item.subtotal.toFixed(2);
        tr.appendChild(subtotalTd);

        const removeTd = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'X';
        removeBtn.addEventListener('click', () => {
          blockStorageList.splice(idx, 1);
          renderBlockStorageTable();
        });
        removeTd.appendChild(removeBtn);
        tr.appendChild(removeTd);

        blockStorageTableBody.appendChild(tr);

        sumIops += item.iops;
        sumSize += (item.size * item.quantity);
        sumQty  += item.quantity;
        sumCost += item.subtotal;
      });

      bsSumIopsEl.textContent     = sumIops;
      bsSumSizeEl.textContent     = sumSize;
      bsSumQtyEl.textContent      = sumQty;
      bsSumSubtotalEl.textContent = 'R$' + sumCost.toFixed(2);

      updateSummary();
    }

    /* ----------------------------------------
       5) OVERALL SUMMARY
    ---------------------------------------- */
    const summaryVmSubtotalEl     = document.getElementById('summaryVmSubtotal');
    const summaryObjectSubtotalEl = document.getElementById('summaryObjectSubtotal');
    const summaryBlockSubtotalEl  = document.getElementById('summaryBlockSubtotal');
    const overallTotalEl          = document.getElementById('overallTotal');

    function updateSummary() {
      // sum VMs
      let vmCost = vmList.reduce((acc, item) => acc + item.subtotal, 0);
      // sum object
      let osCost = objectStorageList.reduce((acc, item) => acc + item.subtotal, 0);
      // sum block
      let blockCost = blockStorageList.reduce((acc, item) => acc + item.subtotal, 0);

      let overall = vmCost + osCost + blockCost;

      summaryVmSubtotalEl.textContent     = 'R$' + vmCost.toFixed(2);
      summaryObjectSubtotalEl.textContent = 'R$' + osCost.toFixed(2);
      summaryBlockSubtotalEl.textContent  = 'R$' + blockCost.toFixed(2);
      overallTotalEl.textContent          = 'R$' + overall.toFixed(2);
    }
  </script>
</body>
</html>
